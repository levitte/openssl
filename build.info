{-
     our $sover = $config{shlib_version_number};
     our $sover_filename = $sover;
     $sover_filename =~ s|\.|_|g
         if $config{target} =~ /^mingw/ || $config{target} =~ /^VC-/;
     $sover_filename =
         sprintf "%02d%02d", split m|\.|, $config{shlib_version_number}
         if $config{target} =~ /^vms/;
     "";
-}
LIBS=libosslalgos libosslcompat libcrypto libssl
# PROOF OF CONCEPT: libosslalgos is a shared library that libcrypto gets
# linked with, just to prove that algos can be placed in a separate shared
# object.  The goal is to make it a DSO.
# libosslcompat is a backward compatibility library, that essentially contains
# all routines that should be abandoned in favor of the EVP interface
#
# libosslalgos uses internal libcrypto structures, which is why we need to
# use crypto/include.  Other algorithm modules are encouraged to create those
# structure dynamically, using public functions.
INCLUDE[libosslalgos]=algorithms/include crypto/include include
DEPEND[libosslalgos]=libcrypto
INCLUDE[libosslcompat]=crypto/include include
DEPEND[libosslcompat]=libcrypto

INCLUDE[libcrypto]=. crypto/include include
INCLUDE[libssl]=. include
DEPEND[libcrypto]=libosslalgos
DEPEND[libssl]=libcrypto

# Empty DEPEND "indices" means the dependencies are expected to be built
# unconditionally before anything else.
DEPEND[]=include/openssl/opensslconf.h crypto/include/internal/bn_conf.h \
         crypto/include/internal/dso_conf.h
DEPEND[include/openssl/opensslconf.h]=configdata.pm
GENERATE[include/openssl/opensslconf.h]=include/openssl/opensslconf.h.in
DEPEND[crypto/include/internal/bn_conf.h]=configdata.pm
GENERATE[crypto/include/internal/bn_conf.h]=crypto/include/internal/bn_conf.h.in
DEPEND[crypto/include/internal/dso_conf.h]=configdata.pm
GENERATE[crypto/include/internal/dso_conf.h]=crypto/include/internal/dso_conf.h.in

IF[{- defined $target{shared_defflag} -}]
  IF[{- $config{target} =~ /^mingw/ -}]
    GENERATE[libosslcompat.def]=util/mkdef.pl compat 32
    DEPEND[libosslcompat.def]=util/libosslcompat.num
    GENERATE[libosslalgos.def]=util/mkdef.pl algorithms 32
    DEPEND[libosslalgos.def]=util/libosslalgos.num
    GENERATE[libcrypto.def]=util/mkdef.pl crypto 32
    DEPEND[libcrypto.def]=util/libcrypto.num
    GENERATE[libssl.def]=util/mkdef.pl ssl 32
    DEPEND[libssl.def]=util/libssl.num

    SHARED_SOURCE[libosslcompat]=libosslcompat.def
    SHARED_SOURCE[libosslalgos]=libosslalgos.def
    SHARED_SOURCE[libcrypto]=libcrypto.def
    SHARED_SOURCE[libssl]=libssl.def
  ELSIF[{- $config{target} =~ /^aix/ -}]
    GENERATE[libosslcompat.map]=util/mkdef.pl compat aix
    DEPEND[libosslcompat.map]=util/libosslcompat.num
    GENERATE[libosslalgos.map]=util/mkdef.pl algorithms aix
    DEPEND[libosslalgos.map]=util/libosslalgos.num
    GENERATE[libcrypto.map]=util/mkdef.pl crypto aix
    DEPEND[libcrypto.map]=util/libcrypto.num
    GENERATE[libssl.map]=util/mkdef.pl ssl aix
    DEPEND[libssl.map]=util/libssl.num

    SHARED_SOURCE[libosslcompat]=libosslcompat.map
    SHARED_SOURCE[libosslalgos]=libosslalgos.map
    SHARED_SOURCE[libcrypto]=libcrypto.map
    SHARED_SOURCE[libssl]=libssl.map
  ELSE
    GENERATE[libosslcompat.map]=util/mkdef.pl compat linux
    DEPEND[libosslcompat.map]=util/libosslcompat.num
    GENERATE[libosslalgos.map]=util/mkdef.pl algorithms linux
    DEPEND[libosslalgos.map]=util/libosslalgos.num
    GENERATE[libcrypto.map]=util/mkdef.pl crypto linux
    DEPEND[libcrypto.map]=util/libcrypto.num
    GENERATE[libssl.map]=util/mkdef.pl ssl linux
    DEPEND[libssl.map]=util/libssl.num

    SHARED_SOURCE[libosslcompat]=libosslcompat.map
    SHARED_SOURCE[libosslalgos]=libosslalgos.map
    SHARED_SOURCE[libcrypto]=libcrypto.map
    SHARED_SOURCE[libssl]=libssl.map
  ENDIF
ENDIF
# VMS and VC don't have parametrised .def / .symvec generation, so they get
# special treatment, since we know they do use these files
IF[{- $config{target} =~ /^VC-/ -}]
  GENERATE[libosslcompat.def]=util/mkdef.pl compat 32
  DEPEND[libosslcompat.def]=util/libosslcompat.num
  GENERATE[libosslalgos.def]=util/mkdef.pl algorithms 32
  DEPEND[libosslalgos.def]=util/libosslalgos.num
  GENERATE[libcrypto.def]=util/mkdef.pl crypto 32
  DEPEND[libcrypto.def]=util/libcrypto.num
  GENERATE[libssl.def]=util/mkdef.pl ssl 32
  DEPEND[libssl.def]=util/libssl.num

  SHARED_SOURCE[libosslcompat]=libosslcompat.def
  SHARED_SOURCE[libosslalgos]=libosslalgos.def
  SHARED_SOURCE[libcrypto]=libcrypto.def
  SHARED_SOURCE[libssl]=libssl.def
ELSIF[{- $config{target} =~ /^vms/ -}]
  GENERATE[libosslcompat.opt]=util/mkdef.pl compat "VMS"
  DEPEND[libosslcompat.opt]=util/libosslcompat.num
  GENERATE[libosslalgos.opt]=util/mkdef.pl algorithms "VMS"
  DEPEND[libosslalgos.opt]=util/libosslalgos.num
  GENERATE[libcrypto.opt]=util/mkdef.pl crypto "VMS"
  DEPEND[libcrypto.opt]=util/libcrypto.num
  GENERATE[libssl.opt]=util/mkdef.pl ssl "VMS"
  DEPEND[libssl.opt]=util/libssl.num

  SHARED_SOURCE[libosslcompat]=libosslcompat.opt
  SHARED_SOURCE[libosslalgos]=libosslalgos.opt
  SHARED_SOURCE[libcrypto]=libcrypto.opt
  SHARED_SOURCE[libssl]=libssl.opt
ENDIF

IF[{- $config{target} =~ /^(?:Cygwin|mingw|VC-)/ -}]
  GENERATE[libosslcompat.rc]=util/mkrc.pl libosslcompat
  GENERATE[libosslalgos.rc]=util/mkrc.pl libosslalgos
  GENERATE[libcrypto.rc]=util/mkrc.pl libcrypto
  GENERATE[libssl.rc]=util/mkrc.pl libssl

  SHARED_SOURCE[libosslcompat]=libosslcompat.rc
  SHARED_SOURCE[libosslalgos]=libosslalgos.rc
  SHARED_SOURCE[libcrypto]=libcrypto.rc
  SHARED_SOURCE[libssl]=libssl.rc
ENDIF

IF[{- $config{target} =~ /^Cygwin/ -}]
 SHARED_NAME[libosslcompat]=cygcrypto-{- $sover_filename -}
 SHARED_NAME[libosslalgos]=cygcrypto-{- $sover_filename -}
 SHARED_NAME[libcrypto]=cygcrypto-{- $sover_filename -}
 SHARED_NAME[libssl]=cygssl-{- $sover_filename -}
ELSIF[{- $config{target} =~ /^mingw/ -}]
 SHARED_NAME[libosslcompat]=libosslcompat-{- $sover_filename -}{- $config{target} eq "mingw64" ? "-x64" : "" -}
 SHARED_NAME[libosslalgos]=libosslalgos-{- $sover_filename -}{- $config{target} eq "mingw64" ? "-x64" : "" -}
 SHARED_NAME[libcrypto]=libcrypto-{- $sover_filename -}{- $config{target} eq "mingw64" ? "-x64" : "" -}
 SHARED_NAME[libssl]=libssl-{- $sover_filename -}{- $config{target} eq "mingw64" ? "-x64" : "" -}
ELSIF[{- $config{target} =~ /^VC-/ -}]
 SHARED_NAME[libosslcompat]=libosslcompat-{- $sover_filename -}{- $target{multilib} -}
 SHARED_NAME[libosslalgos]=libosslalgos-{- $sover_filename -}{- $target{multilib} -}
 SHARED_NAME[libcrypto]=libcrypto-{- $sover_filename -}{- $target{multilib} -}
 SHARED_NAME[libssl]=libssl-{- $sover_filename -}{- $target{multilib} -}
ENDIF

# VMS has a cultural standard where all libraries are prefixed.
# For OpenSSL, the choice is 'ossl$' (this prefix was claimed in a
# conversation with VSI, Tuesday January 26 2016)
# Also, it seems it's usual to have the pointer size the libraries
# were built for as part of the name.
IF[{- $config{target} =~ /^vms/ -}]
 RENAME[libosslcompat]=ossl$libosslcompat{- $target{pointer_size} -}
 RENAME[libosslalgos]=ossl$libosslalgos{- $target{pointer_size} -}
 RENAME[libcrypto]=ossl$libcrypto{- $target{pointer_size} -}
 RENAME[libssl]=ossl$libssl{- $target{pointer_size} -}
 SHARED_NAME[libosslcompat]=ossl$libosslcompat{- $sover_filename -}_shr{- $target{pointer_size} -}
 SHARED_NAME[libosslalgos]=ossl$libosslalgos{- $sover_filename -}_shr{- $target{pointer_size} -}
 SHARED_NAME[libcrypto]=ossl$libcrypto{- $sover_filename -}_shr{- $target{pointer_size} -}
 SHARED_NAME[libssl]=ossl$libssl{- $sover_filename -}_shr{- $target{pointer_size} -}
ENDIF
